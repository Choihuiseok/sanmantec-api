<!-- 생략된 head/body 상단 동일 -->

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // DOM
    const loginView = document.getElementById('login-view');
    const signupView = document.getElementById('signup-view');
    const dashView = document.getElementById('dashboard-view');
    const createView = document.getElementById('create-view');
    const toSignupBtn = document.getElementById('toSignupBtn');
    const toLoginBtn = document.getElementById('toLoginBtn');
    const openCreateBtn = document.getElementById('openCreateBtn');
    const openClaimBtn = document.getElementById('openClaimBtn');
    const emptyCreateBtn = document.getElementById('emptyCreateBtn');
    const cancelCreateBtn = document.getElementById('cancelCreateBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginUserId = document.getElementById('loginUserId');
    const loginPassword = document.getElementById('loginPassword');
    const loginTogglePw = document.getElementById('loginTogglePw');
    const signupUserId = document.getElementById('signupUserId');
    const signupPassword = document.getElementById('signupPassword');
    const signupPassword2 = document.getElementById('signupPassword2');
    const pwMatchMsg = document.getElementById('pwMatchMsg');
    const walletListOutgoing = document.getElementById('wallet-list-outgoing');
    const emptyState = document.getElementById('empty-state');

    // 유틸
    function show(viewEl) {
      [loginView, signupView, dashView, createView].forEach(v => v.classList.add('hidden'));
      viewEl.classList.remove('hidden');
    }

    // 비밀번호 토글
    loginTogglePw.addEventListener('click', () => {
      const showPw = loginPassword.type === 'password';
      loginPassword.type = showPw ? 'text' : 'password';
      loginTogglePw.textContent = showPw ? 'Hide' : 'Show';
    });

    // 회원가입 비밀번호 확인
    function checkMatch() {
      const p1 = signupPassword.value, p2 = signupPassword2.value;
      if (!p1 && !p2) {
        pwMatchMsg.textContent = '';
        pwMatchMsg.className = 'text-xs';
        return;
      }
      if (p1 === p2) {
        pwMatchMsg.textContent = '비밀번호가 일치합니다.';
        pwMatchMsg.className = 'text-xs text-green-600';
      } else {
        pwMatchMsg.textContent = '비밀번호가 일치하지 않습니다.';
        pwMatchMsg.className = 'text-xs text-red-600';
      }
    }
    signupPassword.addEventListener('input', checkMatch);
    signupPassword2.addEventListener('input', checkMatch);

    // 회원가입
    signupView.addEventListener('submit', async (e) => {
      e.preventDefault();
      const userId = signupUserId.value.trim();
      const password = signupPassword.value;

      if (!userId || password.length < 8 || password !== signupPassword2.value) {
        alert('입력 정보를 다시 확인해주세요.');
        return;
      }

      try {
        const response = await fetch("https://sanmantec-api.vercel.app/api/signup", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, password }),
        });
        const result = await response.json();

        if (response.ok) {
          alert(result.message);
          show(loginView);
          loginUserId.value = userId;
          loginPassword.value = '';
        } else {
          alert('회원가입 실패: ' + result.message);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('서버와 연결할 수 없습니다.');
      }
    });

    // 로그인
    loginView.addEventListener('submit', async (e) => {
      e.preventDefault();
      const userId = loginUserId.value.trim();
      const password = loginPassword.value;

      try {
        const response = await fetch("https://sanmantec-api.vercel.app/api/login", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, password }),
        });
        const result = await response.json();

        if (response.ok) {
          alert(result.message);
          show(dashView);
          window._userId = userId; // 로그인 아이디 보관
        } else {
          alert('로그인 실패: ' + result.message);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('서버와 연결할 수 없습니다.');
      }
    });

    // 화면 전환
    toSignupBtn.addEventListener('click', () => show(signupView));
    toLoginBtn.addEventListener('click', () => show(loginView));
    if (logoutBtn) logoutBtn.addEventListener('click', () => { window._userId = null; show(loginView); });

    // ✅ 상단 버튼 → 더미 알림만
    if (openCreateBtn) openCreateBtn.addEventListener('click', () => {
      alert("이 기능은 구현되지 않았습니다.");
    });
    if (openClaimBtn) openClaimBtn.addEventListener('click', () => {
      alert("이 기능은 구현되지 않았습니다.");
    });

    // ✅ emptyCreateBtn → 지갑 생성 화면으로 이동만
    if (emptyCreateBtn) emptyCreateBtn.addEventListener('click', () => show(createView));
    if (cancelCreateBtn) cancelCreateBtn.addEventListener('click', () => show(dashView));

    // ✅ create-view 제출 시 → 실제 API 호출 + 리스트 추가
    createView.addEventListener("submit", async (e) => {
      e.preventDefault();
      const userId = window._userId;
      if (!userId) {
        alert("로그인 후 이용해주세요.");
        show(loginView);
        return;
      }
      try {
        const response = await fetch("https://sanmantec-api.vercel.app/api/wallet/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId }),
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result?.message || "지갑 생성 실패");

        alert((result.message || "지갑 생성 성공"));

        // 지갑 리스트에 추가
        emptyState.classList.add("hidden"); // 빈 상태 숨기기
        const card = document.createElement("div");
        card.className = "p-4 rounded-xl border border-slate-300 bg-white shadow";
        card.innerHTML = `
          <p class="text-sm text-slate-600">주소</p>
          <p class="font-mono break-all text-indigo-600">${result.address}</p>
        `;
        walletListOutgoing.appendChild(card);

        show(dashView);
      } catch (err) {
        console.error(err);
        alert("지갑 생성 실패: " + err.message);
      }
    });

    // 초기화면
    show(loginView);
  });
</script>
